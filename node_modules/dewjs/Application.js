/**
 * @author     LiuZhaoHui <hi.liuzhaoxin@gmail.com>
 * @link       http://www.eatbean.com/nodejs
**/

"use strict";

var fs = require("fs");
var path = require("path");

var Cache = Dew("use", "Common.Cache");

var Application = 
{
    __name__ : "Application", 
    __proto__ : new Cache(), 
    
    // 返回一个 Application 实例
    getInstance : function (options)
    {
        var self = Object.create(this);
        
        if ("string" === typeof options)
        {
            self.addFromFile(options);
        }
        else if (options && "object" === typeof options)
        {
            self._cacheData = options;
        }
        else
        {
            throw new Error("Invalid options provided");
        }
        
        self.addSection("paths", {});
        self.add("dewPath", __dirname);
        self.add("startupPath", path.dirname(process.argv[1]));
        
        return self;
    }, 
    
    // 从文件获取配置
    addFromFile : function (filepath)
    {
        var options = JSON.parse(fs.readFileSync(filepath, "utf8"));
        
        for (var key in options)
        {
            this.addSection(key, options[key]);
        }
    }, 
    
    run : function ()
    {
        this.useSection("server");
        var module = "Server." + this.get("type") + ".Bootstrap";
        var bootstrap = Dew("use", module);
        bootstrap.initialize(this);
        bootstrap.run(this);
    }
};

module.exports = Application;