/**
 * @author     LiuZhaoHui <hi.liuzhaoxin@gmail.com>
 * @link       http://www.eatbean.com/nodejs
**/

"use strict";

var HttpRouter = Dew("use", "Server.Web.Router.HttpRouter");

var HttpFlow = 
{
    __name__ : "HttpFlow", 
    
    _index : 0, 
    _length : 0, 
    
    initialize : function (application)
    {
        
    }, 
    
    // 返回一个 HttpFlow 实例
    getInstance : function (route, context, cache)
    {
        var self = Object.create(this);
        self._cache = cache;
        self._route = route;
        self._context = context;
        self._flow = route.flow;
        self._length = route.flow.length;
        
        if ("controller" in cache)
        {
            self.next();
        }
        else
        {
            var flow = self._flow[self._index++];
            var reference = flow._reference;
            cache.controller = Object.create(reference.object);
            reference.object.__proto__.launch
              .call(cache.controller, context, flow)[reference.method](self);
        }
        
        return self;
    }, 
    
    next : function ()
    {
        if (this._index === this._length)
        {
            HttpRouter.dispatch(this._route, this._context, this._cache);
        }
        else
        {
            var flow = this._flow[this._index++];
            var reference = flow._reference;
            var controller = this._cache.controller;
            controller._route = flow;
            controller.__proto__ = reference.object;
            controller[reference.method](this);
        }
    }
};

module.exports = HttpFlow;