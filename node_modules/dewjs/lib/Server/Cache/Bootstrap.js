/**
 * @author     LiuZhaoHui <hi.liuzhaoxin@gmail.com>
 * @link       http://www.eatbean.com/nodejs
**/

"use strict";

var net = require("net");

var Data = Dew("use", "Server.Cache.Data");
var Connect = Dew("use", "Server.Cache.Connect");

var Bootstrap = 
{
    __name__ : "Bootstrap", 
    
    initialize : function (application)
    {
        application.addFromFile(__dirname + "/Cache.json");
        
        Data.initializer(application);
    }, 
    
    run : function (application)
    {
        application.useSection("server");
        
        var svr = new net.createServer();
        svr.on("connection", Connect.bootstrap.bind(Connect));
        svr.on("listening", this.listening.bind(this, svr));
        svr.on("error", this.error.bind(this));
        svr.on("close", this.close.bind(this));
        svr.setMaxListeners(Infinity);
        svr.listen(application.get("port", 6267), application.get("host", "127.0.0.1"));
    }, 
    
    listening : function (svr)
    {
        console.log("TCP server listening at " + svr.address().address + ":" + svr.address().port);
    }, 
    
    error : function (exception)
    {
        console.log("TCP server encountered error: " + JSON.stringify(exception));
    }, 
    
    close : function ()
    {
        console.log("TCP server closed");
    }
};

module.exports = Bootstrap;